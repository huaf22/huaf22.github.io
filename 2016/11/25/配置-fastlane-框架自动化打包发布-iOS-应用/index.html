<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>  · Hexo</title><meta name="description" content=" - Afluy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/images/avatar.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.afluy.site/atom.xml" title="Hexo"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="images/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="https://github.com/huaf22" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="http://www.jianshu.com/users/86344ec5bfe7/latest_articles" target="_blank" class="nav-list-link">简书</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title"></h1><div class="post-info">Nov 25, 2016</div><div class="post-content"><h2 id="配置-fastlane-框架自动化打包发布-iOS-应用"><a href="#配置-fastlane-框架自动化打包发布-iOS-应用" class="headerlink" title="配置-fastlane-框架自动化打包发布-iOS-应用"></a>配置-fastlane-框架自动化打包发布-iOS-应用</h2><a id="more"></a>
<p><a href="https://github.com/fastlane" target="_blank" rel="external">fastlane</a>/<strong><a href="https://github.com/fastlane/fastlane" target="_blank" rel="external">fastlane</a></strong><br><img src="https://github.com/fastlane/fastlane/raw/master/fastlane/assets/fastlane_text.png" alt=""></p>
<h4 id="安装RVM"><a href="#安装RVM" class="headerlink" title="安装RVM"></a>安装RVM</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -sSL https://get.rvm.io | bash -s stable --ruby</div></pre></td></tr></table></figure>
<p>安装 RVM 是需要管理多版本的 Ruby 环境</p>
<h4 id="安装fastlane"><a href="#安装fastlane" class="headerlink" title="安装fastlane"></a>安装fastlane</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gem install fastlane --verbose</div></pre></td></tr></table></figure>
<h4 id="fastlane初始化"><a href="#fastlane初始化" class="headerlink" title="fastlane初始化"></a>fastlane初始化</h4><p>在项目目录下运行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fastlane init</div></pre></td></tr></table></figure></p>
<p>命令运行时需要输入Apple ID, 运行成功后会生成 fastlane/Fastlane 文件, Fastlane 是一个 ruby 脚本</p>
<h4 id="使用-bundler-管理依赖"><a href="#使用-bundler-管理依赖" class="headerlink" title="使用 bundler 管理依赖"></a>使用 bundler 管理依赖</h4><p><a href="https://docs.fastlane.tools/getting-started/ios/setup/#use-a-gemfile" target="_blank" rel="external">官网介绍</a><br>bundler 用来管理 fastlane 自身版本和 fastlane 运行时的相关依赖版本, 相当于 iOS 开发中的 CocoaPods 框架, 使用方法也和 CocoaPods 如出一辙</p>
<ul>
<li><p>安装 bundler</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo gem install bundler</div><div class="line">``` </div><div class="line">* 在项目根目录下新建 Gemfile 文件并写入</div></pre></td></tr></table></figure>
<p>source “<a href="https://gems.ruby-china.org" target="_blank" rel="external">https://gems.ruby-china.org</a>“</p>
<p>gem “fastlane”<br>gem “cocoapods”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">* 安装依赖库, 生成  Gemfile.lock 文件, 这个文件和我们平常接触的 Podfile.lock 文件功能一致, 配置 CI 时也需要在每次构建前调用该命令</div></pre></td></tr></table></figure>
<p>[sudo] bundle install</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">* 更新 Gemfile.lock 文件</div></pre></td></tr></table></figure>
</li>
</ul>
<p>[sudo] bundle update<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">* 运行 fastlane 框架</div></pre></td></tr></table></figure></p>
<p>bundle exec fastlane [lane]<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">####安装match</div><div class="line">[github官网介绍](https://github.com/fastlane/fastlane/tree/master/match)</div><div class="line">match 是 fastlane 的一个功能组件,  采取了集中化方式来管理证书和 profile,  新建一个私有远程 git 库用来保存证书和 profile, 一个 team 的开发者共用同一套证书, 方便了管理和配置, 同时 match 在证书过期时还会自动从苹果官网下载新的证书并 push 到私有的 git 库中, 保证证书同步, 不得不为这个想法点赞!</div></pre></td></tr></table></figure></p>
<p>gem install match<br>xcode-select –install<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#### match初始化</div></pre></td></tr></table></figure></p>
<p>match init</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">命令运行时需要输入新建的用来保存证书的git地址, 运行成功后会生成 Matchfile 配置文件</div></pre></td></tr></table></figure>
<p>.<br>└── fastlane<br>    ├── Appfile<br>    ├── Fastfile<br>    ├── Matchfile<br>    └── README.md<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">接着运行下面的两条命令来生成证书和 profile</div></pre></td></tr></table></figure></p>
<p>match appstore<br>match development<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">命令运行时需要输入Apple ID 和 密码, 该密码保存在系统的 keychain 中</div><div class="line">&gt; 如果不希望用 match 重新生成证书和 profile, 可以参考[Michał Laskowski](http://macoscope.com/blog/simplify-your-life-with-fastlane-match/#main)的博客</div><div class="line"></div><div class="line">如果当前项目的证书和 profile 比较混乱, 可以用一下两个命令来清空 Apple 官网上当前全部证书和 profile 文件</div></pre></td></tr></table></figure></p>
<p>match nuke development<br>match nuke distribution<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#### match 扩展</div><div class="line">如果 Team 来了新成员, 在 clone 了项目工程后运行下面的命令后, match 就从私有证书库中下载develop 证书和 profile, 并安装到新机上, 新成员就可以调试代码了</div></pre></td></tr></table></figure></p>
<p>match development –readonly<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### Jenkins 配置</div><div class="line"></div><div class="line">![jekins.png](http://upload-images.jianshu.io/upload_images/2591396-1393ffa8757aac0b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</div><div class="line"></div><div class="line"></div><div class="line">#### 遇到的问题</div><div class="line">* 运行 match appstore 时遇到 openssl 库版本问题, 更新 openssl 库</div></pre></td></tr></table></figure></p>
<p>AfluyFileSystem:Remote afluy$ match appstore<br>[19:53:01]: Successfully loaded ‘/Users/afluy/WorkCodeIOS/Remote/fastlane/Matchfile’ 📄<br>….<br>[19:53:01]: Cloning remote git repo…<br>/Library/Ruby/Gems/2.0.0/gems/fastlane_core-0.53.0/lib/fastlane_core/command_executor.rb:46: warning: Insecure world writable dir /Users/afluy/Applications/dex2jar-2.0 in PATH, mode 040777<br>[19:53:02]: 🔓  Successfully decrypted certificates repo<br>[19:53:02]: Verifying that the certificate and profile are still valid on the Dev Portal…<br><a href="-----------------------------------------------------------------------">19:53:20</a>: 🔒  Successfully encrypted certificates repo</p>
<p><a href="-----------------------------------------------------------------------">19:53:20</a>: Connection reset by peer - SSL_connect<br><a href="-----------------------------------------------------------------------">19:53:20</a>:<br><a href="-----------------------------------------------------------------------">19:53:20</a>: SSL errors can be caused by various components on your local machine.<br><a href="-----------------------------------------------------------------------">19:53:20</a>: Apple has recently changed their servers to require TLS 1.2, which may<br><a href="-----------------------------------------------------------------------">19:53:20</a>: not be available to your system installed Ruby (2.0.0)<br><a href="-----------------------------------------------------------------------">19:53:20</a>:<br><a href="-----------------------------------------------------------------------">19:53:20</a>: The best solution is to install a new version of Ruby<br><a href="-----------------------------------------------------------------------">19:53:20</a>:<br><a href="-----------------------------------------------------------------------">19:53:20</a>: - Make sure OpenSSL is installed with Homebrew: <code>brew update &amp;&amp; brew upgrade openssl</code><br><a href="-----------------------------------------------------------------------">19:53:20</a>: - If you use system Ruby:<br><a href="-----------------------------------------------------------------------">19:53:20</a>:   - Run <code>brew update &amp;&amp; brew install ruby</code><br><a href="-----------------------------------------------------------------------">19:53:20</a>: - If you use rbenv with ruby-build:<br><a href="-----------------------------------------------------------------------">19:53:20</a>:   - Run <code>brew update &amp;&amp; brew upgrade ruby-build &amp;&amp; rbenv install ruby-2.3.1</code><br><a href="-----------------------------------------------------------------------">19:53:20</a>:   - Run <code>rbenv global ruby-2.3.1</code> to make it the new global default Ruby version<br><a href="-----------------------------------------------------------------------">19:53:20</a>: - If you use rvm:<br><a href="-----------------------------------------------------------------------">19:53:20</a>:   - First run <code>rvm osx-ssl-certs update all</code><br><a href="-----------------------------------------------------------------------">19:53:20</a>:   - Then run `rvm reinstall ruby-2.3.1 –with-openssl-dir=/usr/local<br><a href="-----------------------------------------------------------------------">19:53:20</a>:<br><a href="-----------------------------------------------------------------------">19:53:20</a>: If that doesn’t fix your issue, please google for the following error message:<br><a href="-----------------------------------------------------------------------">19:53:20</a>:   ‘Connection reset by peer - SSL_connect’</p>
<p>[!] Connection reset by peer - SSL_connect<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">* 运行 match development 时遇到 Apple 账号权限问题, 请使用可以上传 profile 的账号</div></pre></td></tr></table></figure></p>
<p>AfluyFileSystem:Remote afluy$ match development<br>[20:35:02]: Successfully loaded ‘/Users/afluy/WorkCodeIOS/Remote/fastlane/Matchfile’ 📄<br>…<br>[20:35:02]: Cloning remote git repo…<br>[20:35:03]: 🔓  Successfully decrypted certificates repo<br>[20:35:03]: Verifying that the certificate and profile are still valid on the Dev Portal…<br>[20:35:17]: Couldn’t find a valid code signing identity in the git repo for development… creating one for you now<br>…<br>[20:35:17]: Starting login with user ‘zhao.xianhua@whaley.cn’<br>[20:35:22]: Successfully logged in<br>[20:35:25]: $ security import /var/folders/_n/kyvgh8495bv5zmmdg7f85_1r0000gn/T/d20161027-57678-otquli/certs/development/K2935G9MQS.p12 -k ‘/Users/afluy/Library/Keychains/login.keychain’ -T /usr/bin/codesign -T /usr/bin/security<br>[20:35:25]: ▸ 1 key imported.<br>[20:35:25]: $ security import /var/folders/_n/kyvgh8495bv5zmmdg7f85_1r0000gn/T/d20161027-57678-otquli/certs/development/K2935G9MQS.cer -k ‘/Users/afluy/Library/Keychains/login.keychain’ -T /usr/bin/codesign -T /usr/bin/security<br>[20:35:25]: ▸ 1 certificate imported.<br>[20:35:25]: Successfully generated K2935G9MQS which was imported to the local machine.<br>security: SecKeychainSearchCopyNext: The specified item could not be found in the keychain.<br>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current<br>                                 Dload  Upload   Total   Spent    Left  Speed<br>100  1062  100  1062    0     0    825      0  0:00:01  0:00:01 –:–:–   825<br>[20:35:28]: Verifying the certificate is properly installed locally…<br>[20:35:28]: Successfully installed certificate K2935G9MQS</p>
<p>…</p>
<p>[20:35:29]: Starting login with user ‘…’<br>[20:35:31]: Successfully logged in<br>[20:35:31]: Fetching profiles…<br>[20:35:31]: No existing profiles found, that match the certificates you have installed locally! Creating a new provisioning profile for you<br>[20:35:35]: Creating new provisioning profile for ‘…’ with name ‘match Development …’<br>[20:35:38]: An error occured while verifying your certificates and profiles with the Apple Developer Portal.<br>[20:35:38]: If you already have your certificates stored in git, you can run <code>match</code> in readonly mode<br>[20:35:38]: to just install the certificates and profiles without accessing the Dev Portal.<br>[20:35:38]: To do so, just pass <code>readonly: true</code> to your match call.<br>[20:35:38]: 🔒  Successfully encrypted certificates repo</p>
<p>Looking for related GitHub issues on fastlane/fastlane…</p>
<p>Found no similar issues. To create a new issue, please visit:<br><a href="https://github.com/fastlane/fastlane/issues/new" target="_blank" rel="external">https://github.com/fastlane/fastlane/issues/new</a></p>
<p>[!] Apple provided the following error info:<br>    You are not permitted to create provisioning profiles for team.  Please contact one of your team admins, who can create a profile on your behalf.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">* Apple 官网和本地机器上已经有证书, 需要删除官网和本地的证书, 也可以运行上面说的 match nuke 命令来清空已有的证书</div></pre></td></tr></table></figure></p>
<p>AfluyFileSystem:Remote afluy$ match development<br>[10:53:48]: Successfully loaded ‘/Users/afluy/WorkCodeIOS/Remote/fastlane/Matchfile’ 📄<br>…<br>[10:53:48]: Cloning remote git repo…<br>[10:53:54]: 🔓  Successfully decrypted certificates repo<br>[10:53:54]: Verifying that the certificate and profile are still valid on the Dev Portal…<br>[10:54:00]: Couldn’t find a valid code signing identity in the git repo for development… creating one for you now<br>…<br>[10:54:00]: Starting login with user ‘zhao.xianhua@whaley.cn’<br>[10:54:02]: Successfully logged in<br>[10:54:05]: 🔒  Successfully encrypted certificates repo</p>
<p>Looking for related GitHub issues on fastlane/fastlane…</p>
<p>➡️  match: Could not create another certificate, reached the maximum number of available certificates.<br>   <a href="https://github.com/fastlane/fastlane/issues/5765" target="_blank" rel="external">https://github.com/fastlane/fastlane/issues/5765</a> [closed] 4 💬<br>   17 Aug 2016</p>
<p>➡️  Could not create another certificate, reached the maximum number of available certificates.<br>   <a href="https://github.com/fastlane/fastlane/issues/3472" target="_blank" rel="external">https://github.com/fastlane/fastlane/issues/3472</a> [closed] 9 💬<br>   5 weeks ago</p>
<p>➡️  Could not create another certificate, reached the maximum number of available certificates<br>   <a href="https://github.com/fastlane/fastlane/issues/3123" target="_blank" rel="external">https://github.com/fastlane/fastlane/issues/3123</a> [closed] 10 💬<br>   5 weeks ago</p>
<p>and 10 more at: <a href="https://github.com/fastlane/fastlane/search?q=Could%20not%20create%20another%20Development%20certificate,%20reached%20the%20maximum%20number%20of%20available%20Development%20certificates.&amp;type=Issues&amp;utf8=✓" target="_blank" rel="external">https://github.com/fastlane/fastlane/search?q=Could%20not%20create%20another%20Development%20certificate,%20reached%20the%20maximum%20number%20of%20available%20Development%20certificates.&amp;type=Issues&amp;utf8=✓</a></p>
<p>[!] Could not create another Development certificate, reached the maximum number of available Development certificates.<br>```</p>
<ul>
<li>Team 中其他开发者需要在 Xcode 中选择 Automatically manage signing</li>
<li>在 Setting up CocoaPods master repo 卡住, 这个是 CocoaPods 需要全部 clone 下来, 我最终下载了大概 700M 的文件~~</li>
<li>如果不能将改动提交到私有的存储证书的远程 git 库, 可以检查该 git 库的master分支是否被保护</li>
</ul>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p><a href="https://codesigning.guide/" target="_blank" rel="external">https://codesigning.guide/</a><br><a href="https://github.com/fastlane/fastlane" target="_blank" rel="external">https://github.com/fastlane/fastlane</a><br><a href="https://icyleaf.com/2016/07/intro-fastlane-automation-for-ios-and-android/" target="_blank" rel="external">https://icyleaf.com/2016/07/intro-fastlane-automation-for-ios-and-android/</a><br><a href="https://rvm.io/rvm/install" target="_blank" rel="external">https://rvm.io/rvm/install</a><br><a href="https://ruby-china.org/wiki/rvm-guide" target="_blank" rel="external">https://ruby-china.org/wiki/rvm-guide</a><br><a href="https://ruby-china.org/wiki/install_ruby_guide" target="_blank" rel="external">https://ruby-china.org/wiki/install_ruby_guide</a><br><a href="http://macoscope.com/blog/simplify-your-life-with-fastlane-match/#main" target="_blank" rel="external">http://macoscope.com/blog/simplify-your-life-with-fastlane-match/#main</a><br><a href="http://stackoverflow.com/questions/36963467/how-do-i-manually-add-existing-provisioning-profiles-and-certificates-to-fastlan" target="_blank" rel="external">http://stackoverflow.com/questions/36963467/how-do-i-manually-add-existing-provisioning-profiles-and-certificates-to-fastlan</a><br><a href="http://macoscope.com/blog/simplify-your-life-with-fastlane-match/#migration" target="_blank" rel="external">http://macoscope.com/blog/simplify-your-life-with-fastlane-match/#migration</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/11/25/[RxJava学习笔记]-变换的基础方法--lift/" class="prev">PREV</a><a href="/2016/11/25/[JavaScript学习笔记]继承与原型链/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://www.afluy.site">Afluy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>